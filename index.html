<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Interviewer</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        margin: 0;
        background: #0b1220;
        color: #e8eefc;
      }
      .wrap {
        max-width: 900px;
        margin: 0 auto;
        padding: 40px 20px;
      }
      .card {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 16px;
        padding: 22px;
      }
      h1 { margin: 0 0 8px; font-size: 28px; }
      p { margin: 0 0 14px; color: rgba(232, 238, 252, 0.85); line-height: 1.4; }
      .steps { margin-top: 14px; padding-left: 18px; color: rgba(232, 238, 252, 0.85); }
      .badge {
        display: inline-block;
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(99, 102, 241, 0.18);
        border: 1px solid rgba(99, 102, 241, 0.35);
        margin-bottom: 12px;
      }
      .footer { margin-top: 18px; font-size: 12px; color: rgba(232, 238, 252, 0.6); }
    </style>

    <!-- jsPDF (gratis) -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  </head>

  <body>
    <div class="wrap">
      <div class="badge">Gratis · Sin registro</div>

      <div class="card">
        <h1>Simulador de entrevista</h1>
        <p>
          Practica entrevistas con un entrevistador IA. Responde con naturalidad, como si fuera una entrevista real.
        </p>

        <p><strong>Cómo usarlo:</strong></p>
        <ol class="steps">
          <li>Abre el chat (abajo a la derecha).</li>
          <li>Escribe lo que te pide el bot (Nombre, Empresa, Puesto, Seniority).</li>
          <li>Contesta las preguntas.</li>
          <li>Al final podrás descargar tu informe en PDF.</li>
        </ol>

        <div class="footer">
          Tip: responde con ejemplos concretos (situación → acción → resultado).
        </div>
      </div>
    </div>

    <script>
      // 1) Generar y descargar PDF
      function downloadPdf(payload) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: "pt", format: "a4" });

        const report_text = (payload?.report_text || "").toString().trim();
        const candidate_name = (payload?.candidate_name || "").toString();
        const company = (payload?.company || "").toString();
        const role = (payload?.role || "").toString();
        const seniority = (payload?.seniority || "").toString();

        const title = "HR Evaluation Report";
        const meta = [
          candidate_name ? `Candidate: ${candidate_name}` : "",
          company ? `Company: ${company}` : "",
          role ? `Role: ${role}` : "",
          seniority ? `Seniority: ${seniority}` : "",
        ].filter(Boolean).join(" | ");

        const marginX = 40;
        let y = 56;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.text(title, marginX, y);
        y += 18;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        const metaLines = doc.splitTextToSize(meta || "", 515);
        if (metaLines.length) {
          doc.text(metaLines, marginX, y);
          y += metaLines.length * 12 + 14;
        } else {
          y += 8;
        }

        doc.setFontSize(11);

        const text = report_text || "No report text received.";
        const lines = doc.splitTextToSize(text, 515);

        const pageHeight = doc.internal.pageSize.getHeight();
        const bottom = pageHeight - 40;

        for (const line of lines) {
          if (y > bottom) {
            doc.addPage();
            y = 56;
          }
          doc.text(line, marginX, y);
          y += 14;
        }

        const safeName = (candidate_name || "candidate").replace(/[^\w\-]+/g, "_");
        doc.save(`HR_Report_${safeName}.pdf`);
      }

      // 2) ✅ Voiceflow EFFECT EXTENSION (esto es lo clave)
      // Se dispara cuando Voiceflow emite un Custom Action con nombre DOWNLOAD_REPORT_PDF
      const downloadReportExtension = {
        name: "DOWNLOAD_REPORT_PDF",
        type: "effect",
        match: ({ trace }) => trace?.type === "DOWNLOAD_REPORT_PDF",
        effect: async ({ trace }) => {
          // El payload suele venir en trace.payload (según tu Action Body)
          const payload = trace?.payload || {};
          console.log("DOWNLOAD_REPORT_PDF payload:", payload);
          downloadPdf(payload);
        },
      };

      // 3) Cargar widget y registrar extensions
      (function (d, t) {
        var v = d.createElement(t),
          s = d.getElementsByTagName(t)[0];

        v.onload = function () {
          window.voiceflow.chat.load({
            verify: { projectID: "6981de99392d1c3e0b9084bf" },
            url: "https://general-runtime.voiceflow.com",
            versionID: "production",
            voice: { url: "https://runtime-api.voiceflow.com" },

            assistant: {
              extensions: [downloadReportExtension],
            },
          });
        };

        v.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs";
        v.type = "text/javascript";
        s.parentNode.insertBefore(v, s);
      })(document, "script");
    </script>
  </body>
</html>
